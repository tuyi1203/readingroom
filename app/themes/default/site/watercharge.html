{template 'common/header'}
<body>
<style>
.result .table ul li {
    font-size: 50%;
}
.query .result .alert {
    margin-bottom: 5%;
    font-size: .4rem;
    color:red;
}

.invoiceBtn {
    width: 50%;
    background: #f1122f;
    color: #fff;
    height: 1rem;
    line-height: 1rem;
    border: 1px solid #f1122f;
    text-align: center;
    border-radius: .1rem;
    transition: all .3s;
	margin-top:10px;
	margin-bottom:10px;
}

.kaipiaoBtn {
    width: 80%;
    background: #006db2;
    color: #fff;
    height: 1rem;
    line-height: 1rem;
    border: 1px solid #006db2;
    text-align: center;
    border-radius: .1rem;
    transition: all .3s;
    margin-top: 10px;
    margin-bottom: 10px;
}

.huizong {
  margin-top:10px;
}

.tit2 {
    border-top: 0px solid #dadada;
    height: 1rem;
    line-height: 1rem;
    background: #fff;
}

.notice {
	margin-top:15px;
	margin-bottom: 5%;
    font-size: .2rem;
    color:red;
}

.showchk {
  -webkit-appearance:checkbox;
}

</style>
	<header>
		<div class="header">
			<div class="l"><a href="javascript:history.go(-1);" class="back"></a></div>
			<h1>{$title}</h1>
			<div class="r"><a href="javascript:void(0);" class="menuControl" id="_menuLnk"><span><b></b><b></b><b></b></span></a></div>
		</div>
	</header>
	<div class="container">
		<div class="query">
			<div class="form">
				<div class="mod">
					<p>查询类型选择</p>
					<!-- <div>
						<input type="radio" name="type" value="type_cardno" checked="checked" onchange="changeType('cardno_div');" id="type_cardno"/><label for="type_cardno" class="radio-inline">户号</label>
						<input type="radio" name="type" value="type_companyno" id="type_companyno" onchange="changeType('companyno_div');"/><label for="type_companyno" class="radio-inline">单位号</label>
					</div> -->
					<select name="type" onchange="changeType();" id="select_type">
						<option value="type_cardno">按户号</option>
						<option value="type_companyno">按单位号</option>
					</select>
						<!-- <input type="radio" name="type" value="type_cardno" checked="checked" onchange="changeType('cardno_div');" id="type_cardno"/><label for="type_cardno" class="radio-inline">户号</label>
						<input type="radio" name="type" value="type_companyno" id="type_companyno" onchange="changeType('companyno_div');"/><label for="type_companyno" class="radio-inline">单位号</label> -->
				</div>
				<div class="mod" id="cardno_div"><p>请输入您的户号</p><input type="number" name="cardno" class="text" id="cardno" value=""></div>
				<div class="mod" id="companyno_div" style="display:none;">
					<p>单位号</p>
					<input type="text" class="text" style="width:150px;" name="companyno" id="companyno" value="">
				</div>
                <div class="mod"><p>请输入您的电话号码</p><input type="number" name="tel" class="text" id="tel" value=""></div>
                <div class="mod"><p>请选择查询开始日期</p><input type="month" name="feestartdate" class="text" id="feestartdate" value=""></div>
                <div class="mod"><p>请选择查询结束日期</p><input type="month" name="feeenddate" class="text" id="feeenddate" value=""></div>
        <div class="modBtn"><button id="_check">立即查询</button></div>
        <div class="modBtn huizong"><button id="_huizong" onclick="getSumInvoice();">汇总开票</button></div>
			</div>

			<div class="notice">
				<p>温馨提示：</p>
				<ol>
					<li>苹果手机用户无法下载发票的，请前往水务公司PC端官网自行下载；</li>
				</ol>
			</div>
			<div class="result" id="_result" style="display:none;">
				<div class="tips">以下是您的查询结果</div>
				<!-- <div class="table">
					<ul>
						<li class="tit">用户信息</li>
						<li><i>用户编号</i><em>346346346</em></li>
						<li><i>当前余额（元）</i><em class="red">465456.00</em></li>
						<li><i>抄表周期</i><em>每月抄</em></li>
						<li><i>用水类别</i><em>居民生活用水</em></li>
					</ul>
				</div> -->
				<!-- <div class="table">
					<ul>
						<li class="tit">水费信息</li>
						<li><i>抄表年度</i><em>2018</em></li>
						<li><i>抄表月份</i><em>9</em></li>
						<li><i>抄表起吨</i><em>1506</em></li>
						<li><i>抄表止吨</i><em>1660</em></li>
						<li><i>抄表量</i><em>35</em></li>
						<li><i>水费金额（元）</i><em class="red">59.08</em></li>
					</ul>
				</div> -->
				<!-- <div class="txt">
					<p>温馨提示：</p>
					<ol>
						<li>请认真核实缴费号码及用户信息；</li>
						<li>水费信息中的水费金额不含违约金，请以实际缴费金额为准；</li>
						<li>水费实时查询仅提供2013年4月后的数据，如要查询2013年4月以前数据，请拨打2227111电话咨询。</li>
					</ol>
				</div> -->
				<!-- <div class="txt">
					<p>温馨提示：</p>
					<ol>
						<li>苹果手机用户无法下载发票的，请前往水务公司PC端官网自行下载；</li>
					</ol>
				</div> -->
			</div>
		</div>
		{template 'common/inner_guide'}
	</div>
	{template 'common/inner_footer'}

	<div class="pageLoad displayCenter" id="_pageLoad">
		<div class="box">
			<p></p>
			<div class="img">
				<span></span>
				<span></span>
				<span></span>
				<span></span>
				<span></span>
				<span></span>
				<span></span>
			</div>
		</div>
	</div>
<script>
// var flag = 0;
require(["jquery","script"], function($,script){
	$('#_check').bind('click',function(){
		// flag = 1;
		// if(flag == 1){
		// 	script.pageLoadShow('#_pageLoad','查询中，请稍候...');
		// 	setTimeout(function(){
		// 		$('#_result').css('display','block');
		// 		script.pageLoadHide('#_pageLoad');
		// 		flag = 0;
		// 	},3000)
        // }
        var options = {
          method:'POST',
          url:"{php echo url('site/site/watercharge_search');}",
          data:{cardno:$('#cardno').val() , companyno:$('#companyno').val() , type:$('#select_type option:selected').val(), tel:$('#tel').val() , feestartdate:$('#feestartdate').val(), feeenddate:$('#feeenddate').val()},
          beforeSend:function(){
              $('#_result').html('<div class="tips">以下是您的查询结果</div>').hide();
              script.pageLoadShow('#_pageLoad','查询中，请稍候...');
          },
          dataType:'json'
        };
        $.ajax(options).done(function(response)
        {
            console.log(response);
            type = $('input:radio:checked').val();
            if (type == 'type_cardno') {
              cardno = $('#cardno').val();
              optionid = '1';
            } else if (type == 'type_companyno') { 
              cardno = $('#companyno').val();
              optionid = '2';
            }
            phone = $('#tel').val();
            if (response.result == "success")
            {
                var html = new Array();
                for (index in response.data)
                {
                    if ($.isNumeric(index))
                    {
                        html.push('<div class="table"><ul>');                      
                        html.push('<li class="tit"><input id="feeid_'+ response.data[index]['kaipiao_feeid'] +'" type="checkbox" class="showchk" name="feeid_chkbox" value="'+ response.data[index]['kaipiao_feeid'] +'"/>&nbsp;&nbsp;<label for="feeid_'+ response.data[index]['kaipiao_feeid'] +'">查询结果'+ (Number(index)+1) +'</label></li>');
                        for (key in response.data[index])
                        {
                          if (key == 'invoices')
                          {
                            $.each(response.data[index][key] , function(index , value)
                            {
                              if (!Array.isArray(value['invoice_url'])) {
									              html.push('<li key="invoices" class="tit tit2" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;"><button class="invoiceBtn" onclick="openurl(\''+ value['invoice_url'] +'\')">'+ '查看' + value['invoice_name'] +'</button></li>');
                              } else {
                                value['invoice_url'].forEach(function(item, index){
                                  html.push('<li key="invoices" class="tit tit2" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;"><button class="invoiceBtn" onclick="openurl(\''+ item +'\')">'+ '查看' + value['invoice_name'] + '第'+ parseInt((index+1), 10) + '部分'+'</button></li>');
                                });
                              }
                            });
                            continue;
                          }
                          if (key == 'kaipiao_cardno') {
                            html.push('<li class="tit tit2" id="li_'+ response.data[index]['kaipiao_feeid'] +'" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;"><button class="kaipiaoBtn" onclick="getInvoice(this);" data-url="' + "{php echo url('site/site/watercharge_getinvoice');}" + 'feeid=' + response.data[index]['kaipiao_feeid'] + '&cardno=' + response.data[index]['kaipiao_cardno'] + '&phone=' + response.data[index]['kaipiao_phone'] + '&optionid=' + response.data[index]['kaipiao_optionid'] +'">'+ '开具电子发票（已经生成了电子发票的，请勿重复点此按钮！）' +'</button></li>');
                          }
                          if (key != 'kaipiao_cardno' && key != 'kaipiao_phone' && key != 'kaipiao_feeid' && key != 'kaipiao_optionid') {
                            html.push('<li><i>'+ key +'</i>');
                            html.push('<em>'+ response.data[index][key] +'</em></li>');
                          }
                            // html.push('<div class="clear"></div>');
                        }
                        html.push('</ul></div>');            
                    }                    
                }
                $(html.join('')).appendTo('#_result');
                
			} 
			else 
			{
        if ($.type(response.msg) == 'string' )
        {
            $('#_result').html('<div class="alert">'+ response.msg +'</div>');
        }
        else
        {
            $('#_result').html('<div class="alert">'+ response.msg.join("<br>") +'</div>');
        }
        // alert(response.msg);
      }
      script.pageLoadHide('#_pageLoad');
      $('#_result').css('display','block');
    });
	})
});

function openurl(url)
{
	var a = $('<a href="'+ url +'" target="_blank"></a>').get(0);
	var e = document.createEvent('MouseEvents');
	e.initEvent( 'click', true, true );
	a.dispatchEvent(e);
}

function changeType()
{
	$("#companyno_div").hide();
    $("#cardno_div").hide();
	if ($('#select_type option:selected').val() == 'type_cardno')
	{
		$('#cardno_div').show();
	}
    if ($('#select_type option:selected').val() == 'type_companyno')
	{
		$('#companyno_div').show();
	}
}

function getInvoice(obj)
{
  require(["jquery","script"], function($,script){
    liRow = $(obj).parent();
    ul = liRow.parent();
    ul.find('li[key="notice"]').remove();
    var url = $(obj).attr("data-url");
    $.ajax({
        method: "GET",
        url: url,
        dataType: "json",
        beforeSend:function(){
          script.pageLoadShow('#_pageLoad','开票中，请稍候...');
        },
    })
    .done(function(response){
      console.log(response);
      // var li = new Array();
      // if (response.result == 'success') {
      //   var data = response.data;
      //   data.forEach(function(value, index){
      //     if (value['success'] == false) {
      //       // li.push('<p class="notice">'+ value['msg'] +'</p>');
      //       li.push('<li key="notice" class="tit tit2" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;">'+ '<p class="notice">'+ value['msg'] +'</p></li>');
      //     } else {
      //       value['url'].forEach(function(item, index){
      //         if (value['url'].length > 1) {
      //           li.push('<li key="invoices" class="tit tit2" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;"><button class="invoiceBtn" onclick="openurl(\''+ item +'\')">'+ '查看' + value['type_name'] + '第'+ index + '部分'+ '</button></li>');
      //         } else {
      //           li.push('<li key="invoices" class="tit tit2" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;"><button class="invoiceBtn" onclick="openurl(\''+ item +'\')">'+ '查看' + value['type_name'] +'</button></li>');
      //         }
      //       });
      //     }
      //   });
      //   liRow.after(li.join(''));
      // }
      showResult(response, liRow);
      
    })
    .fail(function(){
      alert('服务器忙碌，请稍后再试...');
    })
    .always(function() {
      script.pageLoadHide('#_pageLoad');
    });
  });
}


var cardno, phone, optionid, monthsum = '1';
var feeids = new Array();
var sum_url = "{php echo url('site/site/watercharge_getinvoice');}";
function getSumInvoice()
{
  require(["jquery","script"], function($,script){
    var checkedBox = $('input[name="feeid_chkbox"]:checked');
    if (checkedBox.length < 1) {
        return alert('请勾选需要汇总开票的数据');
    }
    feeids.length = 0;
    checkedBox.each(function() {
      feeids.push($(this).val());
    });

    $.ajax({
      method: "GET",
      url: sum_url + 'feeid=' + feeids.join('-') + '&cardno=' + cardno + '&phone=' + phone + '&optionid=' + optionid + '&monthsum=' + monthsum,
      dataType: "json",
      beforeSend:function(){
        script.pageLoadShow('#_pageLoad','开票中，请稍候...');
      },
    })
    .done(function(response){
      feeids.forEach(function(feeid){
        liRow = $('#li_'+feeid);
        ul = liRow.parent();
        ul.find('li[key="notice"]').remove();
        showResult(response, liRow);
      });
    })
    .always(function() {
      script.pageLoadHide('#_pageLoad');
    })
    .fail(function(){
      alert('服务器忙碌，请稍后再试...');
    });
  });
  


}

function showResult(response, liRow)
{
  var li = new Array();
  if (response.result == 'success') {
    var data = response.data;
    data.forEach(function(value, index){
      if (value['success'] == false) {
        // li.push('<p class="notice">'+ value['msg'] +'</p>');
        li.push('<li key="notice" class="tit tit2" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;">'+ '<p class="notice">'+ value['msg'] +'</p></li>');
      } else {
        value['url'].forEach(function(item, index){
          if (value['url'].length > 1) {
            li.push('<li key="invoices" class="tit tit2" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;"><button class="invoiceBtn" onclick="openurl(\''+ item +'\')">'+ '查看' + value['type_name'] + '第'+ parseInt((index+1), 10) + '部分'+ '</button></li>');
          } else {
            li.push('<li key="invoices" class="tit tit2" style="height: 1.4rem;border-top: 0px solid #dadada;background: #fff;"><button class="invoiceBtn" onclick="openurl(\''+ item +'\')">'+ '查看' + value['type_name'] +'</button></li>');
          }
        });
      }
    });
    liRow.after(li.join(''));
  }
}
</script>
{template 'common/menu'}
</body>
</html>